# Spring Security OAuth2 Client with Authentik Demo

## 如何测试被 Authentik 保护的 API？

可以参考文档：<https://docs.goauthentik.io/add-secure-apps/providers/oauth2/client_credentials/#machine-to-machine-authentication>

1. 创建一个 Service Account，比如：<api-tester>
2. 使用 `client_id` 获得 `access_token`

   ```bash
    andy ~/c/t/2/h/demo integrate-authentik $ curl -s -X POST \
    http://localhost:9000/application/o/token/ \
    -H 'Content-Type: application/x-www-form-urlencoded' \
    --data-urlencode 'grant_type=client_credentials' \
    --data-urlencode 'client_id=<client_id>' \
    --data-urlencode 'username=api-tester' \
    --data-urlencode 'password=<app_password>' \ # Directory > Tokens and App passwords 复制
    --data-urlencode 'scope=openid profile email' | jq
    {
    "access_token": "eyJhbGciOiJSUzI1NiIsImtpZCI6IjA0NjIzYjE4MzBhNzEyY2VlMDc0NjQxNjUzMzM1ZGY5IiwidHlwIjoiSldUIn0.eyJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjkwMDAvYXBwbGljYXRpb24vby9oZWxsby1hLXUvIiwic3ViIjoiMGFmNGY5MjVlYjk4NDllOWEyYjUyZTU2MjQ4MmU4Y2VjOTFlYjE1OWUzNTFiMWM3ZGJhM2RiYTkzNmRmYjgxMSIsImF1ZCI6IjhBSnY3VFo1M1lxaTFtdTZudEROYnFaM3R0ZTdrM3FtRTgzYk41eFkiLCJleHAiOjE3NTczMjcwNDEsImlhdCI6MTc1NzMyNjc0MSwiYXV0aF90aW1lIjoxNzU3MzI2NzQxLCJhY3IiOiJnb2F1dGhlbnRpay5pby9wcm92aWRlcnMvb2F1dGgyL2RlZmF1bHQiLCJlbWFpbCI6IiIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJuYW1lIjoiYXBpLXRlc3QiLCJnaXZlbl9uYW1lIjoiYXBpLXRlc3QiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJhcGktdGVzdCIsIm5pY2tuYW1lIjoiYXBpLXRlc3QiLCJncm91cHMiOlsiYXBpLXRlc3QiXSwiYXpwIjoiOEFKdjdUWjUzWXFpMW11Nm50RE5icVozdHRlN2szcW1FODNiTjV4WSIsInVpZCI6IlpkMVN6ZHJUWmpWMDBNdTJqUmdYMWVldHZEdVA3WFpWVmVDZGlQTUIifQ.L_x7KjLBuTRnFGCPVB2q_SKAML3YU2vewORqt1IoqrvVysNuGd2e_bW3EMU5466tQqHTlnwcEqzNAj17jHUwePT6QizMtNT-3VRsuNCEccgbJfS1v1-dbvK8vBoJqKofHnKI-A3NAjqRCpd1ufqyBWCkSTuBE17wSGBxW8x4O1cxs6qqd54wSYkCApHOUO82-lKpNoutMxZYiTYTqEx1oMHy_47XnL9F1KGgRGY11HP57obwUkxChFTm5v2TvbJzDq3lMtd9idb30usY6VH7Q012MFhXus218EkGrOGUQr49GjyAGWPt906e6NH943itqUDKBizBiFKpagGJOo0RCBFdgPU3TFIDZf-19Y5UAHgpq2u2JwCek5Bhuq2RwbsnJzIV0SD0e6olCoY6qpITqMbRJjzGYjEI5tLRS8pd482vQxSPbM7Tz_nPLL15aJ_155O5FJnGb-VAE1raG6LCdxMjCgMxewiXYTrc7AyHP-2etAzpZW4-m2O8r57vPkEHESCLvL7pAT4PA-nVZ79ooc7JH2qMgnsBKZ3-_I13w6fxww6_2uEnzEuKgCa5XzUqMr-3BjncuAaF-IOWnstwo2VkwYIe5sHMR_6wdMGAi_jaqKM34RYgofDEtPj0FY4Rn7WukLtz-fddCmoXlA9WN0y1DmvNLHYfXNs3RBw8Dd8",
    "token_type": "Bearer",
    "scope": "profile email openid",
    "expires_in": 300,
    "id_token": "eyJhbGciOiJSUzI1NiIsImtpZCI6IjA0NjIzYjE4MzBhNzEyY2VlMDc0NjQxNjUzMzM1ZGY5IiwidHlwIjoiSldUIn0.eyJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjkwMDAvYXBwbGljYXRpb24vby9oZWxsby1hLXUvIiwic3ViIjoiMGFmNGY5MjVlYjk4NDllOWEyYjUyZTU2MjQ4MmU4Y2VjOTFlYjE1OWUzNTFiMWM3ZGJhM2RiYTkzNmRmYjgxMSIsImF1ZCI6IjhBSnY3VFo1M1lxaTFtdTZudEROYnFaM3R0ZTdrM3FtRTgzYk41eFkiLCJleHAiOjE3NTczMjcwNDEsImlhdCI6MTc1NzMyNjc0MSwiYXV0aF90aW1lIjoxNzU3MzI2NzQxLCJhY3IiOiJnb2F1dGhlbnRpay5pby9wcm92aWRlcnMvb2F1dGgyL2RlZmF1bHQiLCJlbWFpbCI6IiIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJuYW1lIjoiYXBpLXRlc3QiLCJnaXZlbl9uYW1lIjoiYXBpLXRlc3QiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJhcGktdGVzdCIsIm5pY2tuYW1lIjoiYXBpLXRlc3QiLCJncm91cHMiOlsiYXBpLXRlc3QiXX0.e-043iDEnMZO4wR-IVbIsaszHYj7RXXEVUI1RhCf9f31ZbkJw6nFI-9DR3qSy8HXuRycFiiuBf9w6b-jQDpgNKTn_vD8yw6snpEV4pBo_jxd924nWU50qql13BQAjRSOZSvlSZph2cLHpzlDG246ahWRicYzTXpHvNSfyOA2KPctG9NBjHwSevhCVrQ8wMOvCjVIG2RMdk6zhoyfvzvZILqvhQnFGvfY4ASlSBPM8u503nOBq4DaOzh6l5rrgdHt1nAIKLaVRuCMlAhmfxwRQFdmo2WIrVt173NBjXYm9jrKaqRAhFpO6fEhGwZHnvLlam2qrhFUsPW5K_DBB2nMSMCQKUtthJCctHLmteE-RJfXMdm9M1oGExx0IuMbXWJXItTFx3XbWlc5jhrDxQWVSqfcmYGaOn3PzPv6RCLlbCps_6ZmWsmFKG6y1X5cuAH4244sOsiKlA8uUEwed8GrHv-WkGYkd4AQepO0dWvtNqo-Qsv1E9IQ9uS2S6N6l25CHYqMStoqBh0AV9UJhoRXNvvKKehlRBOTGDMnJnUyTTOU8c5JJJOft3basf_5gNw1Yd35Y4_i1zwC_5-YnvqHxWRe322AP99UOP-F_LtQOALhML2ora4OaIO-gFVX6dInRph7jOYOIuhjOt2ihPuUFzZIO2TJwzYoLVcEu4nG3NM"
    }

   ```

3. 现在可以访问被保护的 API 了:

   ```bash
   andy ~/c/t/2/h/demo integrate-authentik $ http GET :8080/api/secured/hello 'Authorization:Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6IjA0NjIzYjE4MzBhNzEyY2VlMDc0NjQxNjUzMzM1ZGY5IiwidHlwIjoiSldUIn0.eyJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjkwMDAvYXBwbGljYXRpb24vby9oZWxsby1hLXUvIiwic3ViIjoiMGFmNGY5MjVlYjk4NDllOWEyYjUyZTU2MjQ4MmU4Y2VjOTFlYjE1OWUzNTFiMWM3ZGJhM2RiYTkzNmRmYjgxMSIsImF1ZCI6IjhBSnY3VFo1M1lxaTFtdTZudEROYnFaM3R0ZTdrM3FtRTgzYk41eFkiLCJleHAiOjE3NTczMjcwNDEsImlhdCI6MTc1NzMyNjc0MSwiYXV0aF90aW1lIjoxNzU3MzI2NzQxLCJhY3IiOiJnb2F1dGhlbnRpay5pby9wcm92aWRlcnMvb2F1dGgyL2RlZmF1bHQiLCJlbWFpbCI6IiIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJuYW1lIjoiYXBpLXRlc3QiLCJnaXZlbl9uYW1lIjoiYXBpLXRlc3QiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJhcGktdGVzdCIsIm5pY2tuYW1lIjoiYXBpLXRlc3QiLCJncm91cHMiOlsiYXBpLXRlc3QiXSwiYXpwIjoiOEFKdjdUWjUzWXFpMW11Nm50RE5icVozdHRlN2szcW1FODNiTjV4WSIsInVpZCI6IlpkMVN6ZHJUWmpWMDBNdTJqUmdYMWVldHZEdVA3WFpWVmVDZGlQTUIifQ.L_x7KjLBuTRnFGCPVB2q_SKAML3YU2vewORqt1IoqrvVysNuGd2e_bW3EMU5466tQqHTlnwcEqzNAj17jHUwePT6QizMtNT-3VRsuNCEccgbJfS1v1-dbvK8vBoJqKofHnKI-A3NAjqRCpd1ufqyBWCkSTuBE17wSGBxW8x4O1cxs6qqd54wSYkCApHOUO82-lKpNoutMxZYiTYTqEx1oMHy_47XnL9F1KGgRGY11HP57obwUkxChFTm5v2TvbJzDq3lMtd9idb30usY6VH7Q012MFhXus218EkGrOGUQr49GjyAGWPt906e6NH943itqUDKBizBiFKpagGJOo0RCBFdgPU3TFIDZf-19Y5UAHgpq2u2JwCek5Bhuq2RwbsnJzIV0SD0e6olCoY6qpITqMbRJjzGYjEI5tLRS8pd482vQxSPbM7Tz_nPLL15aJ_155O5FJnGb-VAE1raG6LCdxMjCgMxewiXYTrc7AyHP-2etAzpZW4-m2O8r57vPkEHESCLvL7pAT4PA-nVZ79ooc7JH2qMgnsBKZ3-_I13w6fxww6_2uEnzEuKgCa5XzUqMr-3BjncuAaF-IOWnstwo2VkwYIe5sHMR_6wdMGAi_jaqKM34RYgofDEtPj0FY4Rn7WukLtz-fddCmoXlA9WN0y1DmvNLHYfXNs3RBw8Dd8'
   HTTP/1.1 200
   Cache-Control: no-cache, no-store, max-age=0, must-revalidate
   Connection: keep-alive
   Content-Length: 135
   Content-Type: text/plain;charset=UTF-8
   Date: Mon, 08 Sep 2025 10:19:50 GMT
   Expires: 0
   Keep-Alive: timeout=60
   Pragma: no-cache
   X-Content-Type-Options: nosniff
   X-Frame-Options: DENY
   X-XSS-Protection: 0

   Hello, 0af4f925eb9849e9a2b52e562482e8cec91eb159e351b1c7dba3dba936dfb811! You are accessing a secured endpoint. Your authorities are: []
   ```
